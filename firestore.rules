rules_version = '2';

function isSignedIn() {
  return request.auth != null;
}

function isSelf(uid) {
  return isSignedIn() && request.auth.uid == uid;
}

// current user role ကို users collection ကနေ ယူပြီး staff စစ်ရန်
function myRole() {
  return isSignedIn()
    ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
    : null;
}
function isStaff() {
  return ['owner','admin','instructor','ta'].hasAny([myRole()]);
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Public catalog ဖတ်လို့ရ
    match /courses/{courseId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }
    match /courses/{courseId}/lessons/{lessonId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }
    match /courses/{courseId}/quizzes/{quizId} {
      allow read: if true;
      allow create, update, delete: if isStaff();
    }

    // Users — ကိုယ်ပိုင် profile ကို ကိုယ်တိုင် create/update လုပ်နိုင်
    match /users/{uid} {
      allow read: if isSelf(uid) || isStaff();
      allow create: if isSelf(uid);
      allow update: if isSelf(uid) || isStaff();
    }

    // Enrollments — ကိုယ်တိုင် create/read OK; staff read OK
    match /enrollments/{id} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSelf(resource.data.userId) || isStaff();
      allow delete, update: if isSelf(resource.data.userId) || isStaff();
    }

    // Quiz attempts — ကိုယ်တိုင် create/read OK; staff read OK
    match /attempts/{id} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSelf(resource.data.userId) || isStaff();
      allow delete, update: if isStaff();
    }
  }
}